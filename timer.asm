.INCLUDE "M8DEF.INC"

.EQU TIMER1_INTERVAL = 235
.EQU TIMER2_INTERVAL = 215

.CSEG
.ORG 0x000
    RJMP MAIN_PROGRAM
.ORG 0x004
    RJMP TIMER2_ISR
.ORG 0x009
    RJMP TIMER1_ISR

TIMER1_STR: .DB "ping\r\n", 0, 0
TIMER2_STR: .DB "pong\r\n", 0, 0

MAIN_PROGRAM:
    LDI R16, HIGH(RAMEND)
    OUT SPH, R16
    LDI R16, LOW(RAMEND)
    OUT SPL, R16

    LDI R16, HIGH(8000000 / (16 * 115200) - 1)
    OUT UBRRH, R16
    LDI R16, LOW(8000000 / (16 * 115200) - 1)
    OUT UBRRL, R16

    LDI R16, 0x18
    OUT UCSRB, R16
    LDI R16, 0x86
    OUT UCSRC, R16

    LDI R16, TIMER1_INTERVAL
    OUT TCNT0, R16

    LDI R16, TIMER2_INTERVAL
    OUT TCNT2, R16

    LDI R16, 0x2
    OUT TCCR0, R16

    LDI R16, 0x5
    OUT TCCR2, R16

    LDI R16, 0x41
    OUT TIMSK, R16

    SEI

MAIN_LOOP:
    RJMP MAIN_LOOP

TIMER1_ISR:
    SEI

    LDI R18, TIMER1_INTERVAL
    OUT TCNT0, R18

    LDI ZH, HIGH(2 * TIMER1_STR)
    LDI ZL, LOW(2 * TIMER1_STR)

    RETI

TIMER2_ISR:
    SEI

    LDI R19, TIMER2_INTERVAL
    OUT TCNT2, R19

    LDI ZH, HIGH(2 * TIMER2_STR)
    LDI ZL, LOW(2 * TIMER2_STR)

    RETI
 
WORD1_BYTE:
    LPM R17, Z+
    CPI R17, 0
    BREQ STOP
    RCALL SEND_BYTE 
    RJMP WORD1_BYTE

WORD2_BYTE:
    LPM R17, Z+
    CPI R17, 0
    BREQ STOP
    RCALL SEND_BYTE 
    RJMP WORD2_BYTE

STOP:
    RET

SEND_BYTE:
    SBIS UCSRA, UDRE
    RJMP SEND_BYTE 
    OUT UDR, R17
    RET